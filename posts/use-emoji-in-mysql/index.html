<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Use emoji in MySQL | Godot's Blog - 个人生活分享</title><meta name=keywords content="mysql"><meta name=description content="最近碰到一个服务器报错，排查后发现是参数中包含了 emoji，导致数据库插入记录失败了。
虽然业务上不要求支持，但好奇之下，我还是基于 MySQL 做了个实验。
What&rsquo;s emoji 🧐 关于 emoji 比较官方的解释：
Emoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.
那么 emoji 是怎么来的呢：
Emoji are &ldquo;picture characters&rdquo; originally associated with cellular telephone usage in Japan, but now popular worldwide."><meta name=author content><link rel=canonical href=https://iamgodot.com/posts/use-emoji-in-mysql/><link crossorigin=anonymous href=/assets/css/stylesheet.min.7cb1aaa4414c482febc7034a427761d087a2cf358f1be8f7beba5afc947b57d0.css integrity="sha256-fLGqpEFMSC/rxwNKQndh0IeizzWPG+j3vrpa/JR7V9A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://iamgodot.com/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://iamgodot.com/icons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://iamgodot.com/icons/favicon-32x32.png><link rel=apple-touch-icon href=https://iamgodot.com/icons/apple-touch-icon.png><link rel=mask-icon href=https://iamgodot.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Source+Code+Pro:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Source+Code+Pro:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=preconnect href=https://plausible.iamgodot.com><script defer data-domain=iamgodot.com src=https://plausible.iamgodot.com/js/plausible.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><script></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-157042624-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Use emoji in MySQL"><meta property="og:description" content="最近碰到一个服务器报错，排查后发现是参数中包含了 emoji，导致数据库插入记录失败了。
虽然业务上不要求支持，但好奇之下，我还是基于 MySQL 做了个实验。
What&rsquo;s emoji 🧐 关于 emoji 比较官方的解释：
Emoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.
那么 emoji 是怎么来的呢：
Emoji are &ldquo;picture characters&rdquo; originally associated with cellular telephone usage in Japan, but now popular worldwide."><meta property="og:type" content="article"><meta property="og:url" content="https://iamgodot.com/posts/use-emoji-in-mysql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-21T17:22:18+08:00"><meta property="article:modified_time" content="2020-11-21T17:22:18+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Use emoji in MySQL"><meta name=twitter:description content="最近碰到一个服务器报错，排查后发现是参数中包含了 emoji，导致数据库插入记录失败了。
虽然业务上不要求支持，但好奇之下，我还是基于 MySQL 做了个实验。
What&rsquo;s emoji 🧐 关于 emoji 比较官方的解释：
Emoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.
那么 emoji 是怎么来的呢：
Emoji are &ldquo;picture characters&rdquo; originally associated with cellular telephone usage in Japan, but now popular worldwide."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://iamgodot.com/posts/"},{"@type":"ListItem","position":3,"name":"Use emoji in MySQL","item":"https://iamgodot.com/posts/use-emoji-in-mysql/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Use emoji in MySQL","name":"Use emoji in MySQL","description":"最近碰到一个服务器报错，排查后发现是参数中包含了 emoji，导致数据库插入记录失败了。\n虽然业务上不要求支持，但好奇之下，我还是基于 MySQL 做了个实验。\nWhat\u0026rsquo;s emoji 🧐 关于 emoji 比较官方的解释：\nEmoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.\n那么 emoji 是怎么来的呢：\nEmoji are \u0026ldquo;picture characters\u0026rdquo; originally associated with cellular telephone usage in Japan, but now popular worldwide.","keywords":["mysql"],"articleBody":"最近碰到一个服务器报错，排查后发现是参数中包含了 emoji，导致数据库插入记录失败了。\n虽然业务上不要求支持，但好奇之下，我还是基于 MySQL 做了个实验。\nWhat’s emoji 🧐 关于 emoji 比较官方的解释：\nEmoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.\n那么 emoji 是怎么来的呢：\nEmoji are “picture characters” originally associated with cellular telephone usage in Japan, but now popular worldwide. The word emoji comes from the Japanese 絵 (e ≅ picture) + 文字 (moji ≅ written character).\n关于更详细的说明，可以阅读这篇文章：Everything you need to know about emoji。\nCharset in MySQL MySQL 中的 utf8（也就是 utf8mb3）最多只用 3 个字节编码，所以是无法支持 BMP（简单来说就是绝大部分的文字和符号）以外的字符的，emoji（需要 4 个字节表示）就是其中之一，此时就需要使用 utf8mb4 编码，如下图所示：\nCharset 有多个级别的设置，可以只对单表或者单列使用 utf8mb4，毕竟这种方式要占用更多的存储空间。\nMySQL 对 Charset 的支持分为以下几种，从上到下的粒度依次减小，如果某一级没有显式设定的话会默认使用上一级的配置：\ncharacter_set_server character_set_database table character set column character set 前两者可以在 show variables like \"character%\"; 的结果中找到，后面两个（如果指定了的话）可以通过建表语句 show create table t_name; 查看。\nMore charset in MySQL 按理说完成上述设置后字段就能够支持 emoji 了，但插入时却失败了：\n原因是还有变量没设置正确：\ncharacter_set_client 和 character_set_connection 的值还是 utf8，它们控制的分别是客户端在交互和传输过程中使用的字符集。更新之后插入成功，但查询结果却显示乱码：\n这是因为 character_set_results 还没改过来，它表示服务器在回传响应时使用的字符集。再次更新后，便一切正常了：\nDjango settings 在服务器开发中，还要记得更改代码中的 Charset，比如 Django 里的配置：\nDATABASES = { \"default\": { # ... \"OPTIONS\": { \"charset\": \"utf8mb4\", # ... } } } 除了更换字符集，也有应用层的解决方案。比如先维护 emoji 与普通字符串的映射，然后在存储前和查询后做转换。虽然麻烦些，但好处是不破坏现有数据库的状态，更加灵活地控制转换逻辑。\n当然，如果能在一开始确认需求，比如为用户名或评论支持 emoji，然后建表时直接使用 utf8mb4 是最好的。\n","wordCount":"181","inLanguage":"en","datePublished":"2020-11-21T17:22:18+08:00","dateModified":"2020-11-21T17:22:18+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://iamgodot.com/posts/use-emoji-in-mysql/"},"publisher":{"@type":"Organization","name":"Godot's Blog - 个人生活分享","logo":{"@type":"ImageObject","url":"https://iamgodot.com/icons/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://iamgodot.com accesskey=h title="Godot's Blog - 个人生活分享 (Alt + H)">Godot's Blog - 个人生活分享</a>
<span class=logo-switches></span></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Use emoji in MySQL</h1><div class=post-meta><span title='2020-11-21 17:22:18 +0800 +0800'>11-21</span>&nbsp;·&nbsp;1 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#whats-emoji- aria-label="What&amp;rsquo;s emoji 🧐">What&rsquo;s emoji 🧐</a></li><li><a href=#charset-in-mysql aria-label="Charset in MySQL">Charset in MySQL</a></li><li><a href=#more-charset-in-mysql aria-label="More charset in MySQL">More charset in MySQL</a></li><li><a href=#django-settings aria-label="Django settings">Django settings</a></li></ul></div></details></div><div class=post-content><p>最近碰到一个服务器报错，排查后发现是参数中包含了 emoji，导致数据库插入记录失败了。</p><p>虽然业务上不要求支持，但好奇之下，我还是基于 MySQL 做了个实验。</p><h1 id=whats-emoji->What&rsquo;s emoji 🧐<a hidden class=anchor aria-hidden=true href=#whats-emoji->#</a></h1><p>关于 emoji 比较官方的解释：</p><blockquote><p>Emoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.</p></blockquote><p>那么 emoji 是怎么来的呢：</p><blockquote><p>Emoji are &ldquo;picture characters&rdquo; originally associated with cellular telephone usage in Japan, but now popular worldwide. The word emoji comes from the Japanese 絵 (e ≅ picture) + 文字 (moji ≅ written character).</p></blockquote><p>关于更详细的说明，可以阅读这篇文章：<a href=https://www.smashingmagazine.com/2016/11/character-sets-encoding-emoji/>Everything you need to know about emoji</a>。</p><h1 id=charset-in-mysql>Charset in MySQL<a hidden class=anchor aria-hidden=true href=#charset-in-mysql>#</a></h1><p>MySQL 中的 <code>utf8</code>（也就是 <code>utf8mb3</code>）最多只用 3 个字节编码，所以是无法支持 <a href=https://en.wikipedia.org/wiki/Plane_(Unicode)>BMP</a>（简单来说就是绝大部分的文字和符号）以外的字符的，emoji（需要 4 个字节表示）就是其中之一，此时就需要使用 <code>utf8mb4</code> 编码，如下图所示：</p><p><img loading=lazy src=https://static.iamgodot.com/content/images/2242299f3a78a9008c42e9162d4c31ee.png alt></p><p>Charset 有多个级别的设置，可以只对单表或者单列使用 <code>utf8mb4</code>，毕竟这种方式要占用更多的存储空间。</p><p>MySQL 对 Charset 的支持分为以下几种，从上到下的粒度依次减小，如果某一级没有显式设定的话会默认使用上一级的配置：</p><ul><li><code>character_set_server</code></li><li><code>character_set_database</code></li><li><code>table character set</code></li><li><code>column character set</code></li></ul><p>前两者可以在 <code>show variables like "character%";</code> 的结果中找到，后面两个（如果指定了的话）可以通过建表语句 <code>show create table t_name;</code> 查看。</p><h1 id=more-charset-in-mysql>More charset in MySQL<a hidden class=anchor aria-hidden=true href=#more-charset-in-mysql>#</a></h1><p>按理说完成上述设置后字段就能够支持 emoji 了，但插入时却失败了：</p><p><img loading=lazy src=https://static.iamgodot.com/content/images/4ba81444f24f7e49aecb7cbf9f8605f1.png alt></p><p>原因是还有变量没设置正确：</p><p><img loading=lazy src=https://static.iamgodot.com/content/images/f052fdc1a96804c876dc089077cdd657.png alt></p><p><code>character_set_client</code> 和 <code>character_set_connection</code> 的值还是 <code>utf8</code>，它们控制的分别是客户端在交互和传输过程中使用的字符集。更新之后插入成功，但查询结果却显示乱码：</p><p><img loading=lazy src=https://static.iamgodot.com/content/images/66ff09d89c59a36755278c296462ae09.png alt></p><p>这是因为 <code>character_set_results</code> 还没改过来，它表示服务器在回传响应时使用的字符集。再次更新后，便一切正常了：</p><p><img loading=lazy src=https://static.iamgodot.com/content/images/9bca21f21f1dc99235efa27a1e51e1d3.png alt></p><h1 id=django-settings>Django settings<a hidden class=anchor aria-hidden=true href=#django-settings>#</a></h1><p>在服务器开发中，还要记得更改代码中的 Charset，比如 Django 里的配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>DATABASES <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;default&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;OPTIONS&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;charset&#34;</span>: <span style=color:#e6db74>&#34;utf8mb4&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><p>除了更换字符集，也有应用层的解决方案。比如先维护 emoji 与普通字符串的映射，然后在存储前和查询后做转换。虽然麻烦些，但好处是不破坏现有数据库的状态，更加灵活地控制转换逻辑。</p><p>当然，如果能在一开始确认需求，比如为用户名或评论支持 emoji，然后建表时直接使用 <code>utf8mb4</code> 是最好的。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://iamgodot.com/tags/mysql/>mysql</a></li></ul><nav class=paginav><a class=prev href=https://iamgodot.com/posts/the-silverlining/><span class=title>« Prev Page</span><br><span>生命之光</span></a>
<a class=next href=https://iamgodot.com/posts/the-art-of-readable-code/><span class=title>Next Page »</span><br><span>The Art of Readable Code</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=iamgodot/godot-blog-comments data-repo-id="MDEwOlJlcG9zaXRvcnkzOTk0Nzk0MTY=" data-category=Announcements data-category-id=DIC_kwDOF8-SeM4CO3OX data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=dark_dimmed data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2020-2023 <a href=https://iamgodot.com>Godot's Blog - 个人生活分享</a></span>
<span>| <a href=http://beian.miit.gov.cn/ target=_blank>京ICP备20005558号-2</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>